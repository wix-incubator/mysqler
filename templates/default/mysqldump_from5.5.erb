#!/bin/bash

# Generated by Chef for <%= node["fqdn"] %>. 
# Local modifications will be overwritten. 
# Cookbook: <%= node['mysqler']["templates_cookbook"] %> 
# Template: mysqldump_from5.5.erb 

pass='<%= @host_pass %>'

replica_user='<%= @replica_user %>'
replica_pass='<%= @replica_pass %>'
rebuilding_file='<%= @rebuilding_file %>'


lock_file='<%= (defined? Chef::Config::start_handlers[0].lock_file) ? Chef::Config::start_handlers[0].lock_file : '/tmp/chef.lock' %>'

#run in the background
(
echo "running mysql restore from mysql5.5 locking chef" > $lock_file;

<% @dumped_port ||= 3306 %>
remote_mysql="mysql -h <%= @dumped_host %>  -P<%= @dumped_port %> -u<%= @dumped_user %> -p<%= @dumped_password %> "

databases=`$remote_mysql --skip-column-names -e "SELECT GROUP_CONCAT(schema_name SEPARATOR ' ') FROM information_schema.schemata WHERE schema_name NOT IN ('performance_schema','information_schema', 'mysql');" `

mysqldump="mysqldump --defaults-file=<%= node['mysqler']['defaults-file'] %> -h <%= @dumped_host %> -P<%= @dumped_port %> -u<%= @dumped_user %> -p<%= @dumped_password %> -f -R -C -q --single-transaction --order-by-primary  --complete-insert <%= @ignore_tables.map{|t| "--ignore-table=#{t}"}.join(" ") %>"


local_mysql="mysql --defaults-file=<%= node['mysqler']['defaults-file'] %> -p$pass "

#create file that will indicate that the process have started
echo "started to execute rebuild on `date`" >> $rebuilding_file

<% if !node['mysqler']['mysql_rebuild']['schema_changes'].to_s.empty?  %> 
$remote_mysql -e 'stop slave;'
$mysqldump --no-data --databases $databases | $local_mysql
echo "Applying schema changes <%= node['mysqler']['mysql_rebuild']['schema_changes'] %> " >> $rebuilding_file 
$local_mysql -e "<%= node['mysqler']['mysql_rebuild']['schema_changes'] %>"
echo "Applying schema changes - done" >> $rebuilding_file
mysqldump="$mysqldump --no-create-info"
<% end -%>
mysqldump="$mysqldump --databases $databases"
echo "Starting to run mysqldump" >> $rebuilding_file
$mysqldump <%
    if (@rebuild_from_master == 1) 
      -%> --master-data<% 
    else 
      -%> --dump-slave  --include-master-host-port<% 
    end 
-%> --apply-slave-statements 2>>$rebuilding_file <%
%> | sed "s/^\(CHANGE MASTER TO .* MASTER_PORT=\)'\([0-9]\+\)'/\1\2/" | sed '1i set sql_log_bin=0;' | sed "s/^CHANGE MASTER TO \(.*\)/change master to <% 
  if (@rebuild_from_master == 1) 
    -%> master_host='<%= @dumped_host %>', master_port=<%= @dumped_port %>, <% 
  end 
-%> master_user='$replica_user', master_password='$replica_pass', \1 start slave io_thread;/" | $local_mysql

if [ $? -eq 0 ] ; then
  echo "Flushing privileges" >> $rebuilding_file
  echo "flush privileges;" | $local_mysql
  echo "finished mysqldump on `date` running mysql_upgrade" >> $rebuilding_file
  mysql_upgrade  --defaults-file=<%= node['mysqler']['defaults-file'] %> -p$pass
  echo "completed to execute rebuild on `date`" >> $rebuilding_file
else
  echo "FAILED to perform rebuild `date`" >> $rebuilding_file
fi ;
/bin/rm $lock_file 
) & disown

sleep 20 
<% if !(@rebuild_from_master == 1) -%>
#start slave on the dumped host (stopped by mysqldump)
echo "start slave;" | mysql -h <%= @dumped_host %>  -P<%= @dumped_port %> -u<%= @dumped_user %> -p<%= @dumped_password %>
<% end -%>
